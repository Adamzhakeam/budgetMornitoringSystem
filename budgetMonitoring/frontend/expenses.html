<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget & Expense Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --light-bg: #f8f9fa;
            --dark-bg: #212529;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #495057;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
        }
        
        .navbar {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .card {
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            margin-bottom: 24px;
            border: none;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: linear-gradient(120deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 0 !important;
            padding: 18px 24px;
            font-weight: 600;
            border: none;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            padding: 14px 16px;
            border: 1.5px solid #e2e8f0;
            transition: var(--transition);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(120deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 10px;
            padding: 14px 28px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            background: linear-gradient(120deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
        }
        
        .expense-summary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 20px rgba(106, 17, 203, 0.2);
        }
        
        .file-upload-container {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 32px 24px;
            text-align: center;
            transition: var(--transition);
            background-color: #f8fafc;
        }
        
        .file-upload-container:hover {
            border-color: var(--primary-color);
            background-color: #f0f7ff;
            transform: scale(1.01);
        }
        
        .file-preview {
            margin-top: 16px;
            max-width: 100%;
            border-radius: 12px;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .budget-item {
            border-left: 4px solid var(--primary-color);
            padding: 16px;
            margin-bottom: 16px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            transition: var(--transition);
        }
        
        .budget-item:hover {
            transform: translateX(5px);
        }
        
        .notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 18px 24px;
            border-radius: 12px;
            background-color: var(--dark-bg);
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .detail-item {
            display: flex;
            margin-bottom: 16px;
            padding: 16px;
            background-color: #f8fafc;
            border-radius: 12px;
            gap: 12px;
            transition: var(--transition);
        }
        
        .detail-item:hover {
            background-color: #edf2f7;
        }
        
        .detail-item input, .detail-item select {
            flex: 1;
            margin-right: 0;
        }
        
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: -0.125em;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }
        
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        
        .recent-expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f1f3f4;
            transition: var(--transition);
        }
        
        .recent-expense-item:hover {
            background-color: #f8f9fa;
        }
        
        .progress {
            height: 12px;
            border-radius: 10px;
            background-color: #e9ecef;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transition: width 0.6s ease;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .stat-card h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--dark-bg);
        }
        
        .stat-card p {
            color: #6c757d;
            margin: 0;
        }
        
        /* Modern toggle switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        .toggle-text {
            margin-right: 10px;
            font-weight: 500;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Dark mode support */
        .dark-mode {
            --light-bg: #121212;
            --dark-bg: #e4e4e4;
            background-color: #1e1e1e;
            color: #e4e4e4;
        }
        
        .dark-mode .card {
            background-color: #2d2d2d;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode .form-control, 
        .dark-mode .form-select {
            background-color: #3d3d3d;
            border-color: #4d4d4d;
            color: #e4e4e4;
        }
        
        .dark-mode .stat-card {
            background-color: #2d2d2d;
            color: #e4e4e4;
        }
        
        .dark-mode .stat-card p {
            color: #a0a0a0;
        }
        
        /* Custom styles for combobox */
        .combobox-container {
            position: relative;
        }
        
        .combobox-container select {
            padding-right: 30px;
        }
        
        .combobox-container::after {
            content: "\f078";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #6c757d;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .detail-item {
                flex-direction: column;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-coins me-2"></i>Budget Management System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-home me-1"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-file-invoice-dollar me-1"></i> Expenses</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-chart-pie me-1"></i> Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-cog me-1"></i> Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5">
        <!-- Dashboard Stats -->
        
        <div class="toggle-container">
            <span class="toggle-text">Dark Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
            </label>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-plus-circle me-2"></i>Add New Expense
                    </div>
                    <div class="card-body">
                        <form id="expenseForm">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label for="budgetId" class="form-label">Select Budget <span class="text-danger">*</span></label>
                                    <select class="form-select" id="budgetId" required>
                                        <option value="">Loading budgets...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="dateOfExpense" class="form-label">Date of Expense <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="dateOfExpense" required>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label">Expense Details <span class="text-danger">*</span></label>
                                <div id="detailsContainer">
                                    <div class="detail-item">
                                        <div class="combobox-container" style="flex: 1;">
                                            <input type="text" class="form-control item-input" list="itemOptions" placeholder="Item" required>
                                        </div>
                                        <div class="combobox-container" style="flex: 1;">
                                            <input type="text" class="form-control category-input" list="categoryOptions" placeholder="Category" required>
                                        </div>
                                        <input type="number" class="form-control" placeholder="Quantity" min="1" required>
                                        <input type="number" class="form-control" placeholder="Amount" min="0" step="0.01" required>
                                        <button type="button" class="btn btn-danger remove-detail"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <button type="button" id="addDetail" class="btn btn-sm btn-outline-primary mt-2">
                                    <i class="fas fa-plus me-1"></i> Add Item
                                </button>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label for="amountSpent" class="form-label">Total Amount Spent ($) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="amountSpent" placeholder="0.00" min="0" step="0.01" required readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="beneficially" class="form-label">Beneficiary <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="beneficially" placeholder="Who received the payment?" required>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="evidence" class="form-label">Evidence (Receipt/Invoice) <span class="text-danger">*</span></label>
                                <div class="file-upload-container" id="fileUploadContainer">
                                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                                    <h5>Drag & Drop your file here</h5>
                                    <p class="text-muted">Supported formats: JPG, PNG, PDF (Max: 5MB)</p>
                                    <input type="file" class="d-none" id="evidence" accept=".jpg,.jpeg,.png,.pdf" required>
                                    <button type="button" class="btn btn-primary mt-2" onclick="document.getElementById('evidence').click()">
                                        <i class="fas fa-file-upload me-2"></i>Select File
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <img id="filePreview" class="file-preview img-fluid" src="#" alt="File preview">
                                    <div id="fileName" class="text-center mt-2 fw-bold"></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="others" class="form-label">Additional Notes (Optional)</label>
                                <textarea class="form-control" id="others" rows="3" placeholder="Any additional information about this expense..."></textarea>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i>Submit Expense
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-info-circle me-2"></i>Selected Budget Details
                    </div>
                    <div class="card-body">
                        <div id="budgetDetails" class="text-center py-4">
                            <i class="fas fa-coins fa-3x text-secondary mb-3"></i>
                            <p>Select a budget to view details</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-receipt me-2"></i>Recent Expenses
                    </div>
                    <div class="card-body p-0">
                        <div id="recentExpenses">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-receipt fa-2x mb-3"></i>
                                <p>Loading recent expenses...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Datalists for category and item options -->
    <datalist id="categoryOptions"></datalist>
    <datalist id="itemOptions"></datalist>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle me-2"></i>
        <span id="notificationText">Expense added successfully!</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API endpoints
        const API_ENDPOINTS = {
            GET_BUDGETS: 'http://192.168.73.170:5000/getBudget',
            GET_BUDGET_DETAILS: 'http://192.168.73.170:5000/getBudget',
            ADD_EXPENSE: 'http://192.168.73.170:5000/addExpense',
            GET_RECENT_EXPENSES: 'http://192.168.73.170:5000/getAllExpenses',
            GET_DASHBOARD_STATS: 'http://192.168.73.170:5000/getBudget',
            SEARCH_CHART_ACCOUNTS: 'http://192.168.73.170:5000/getAnyChartAccount'
        };

        // Global variables for storing category and item options
        let allCategories = new Set();
        let allItems = new Set();
        let currentBudgetCategories = [];
        let currentBudgetItems = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application
            initApp();
            
            // Set today's date as default for dateOfExpense
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateOfExpense').value = today;
            
            // Add event listeners
            document.getElementById('addDetail').addEventListener('click', addDetailItem);
            document.getElementById('expenseForm').addEventListener('submit', handleSubmit);
            document.getElementById('evidence').addEventListener('change', handleFileSelect);
            document.getElementById('budgetId').addEventListener('change', updateBudgetDetails);
            document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
            
            // Calculate total amount when any detail input changes
            document.getElementById('detailsContainer').addEventListener('input', calculateTotalAmount);
            
            // Enable file drop functionality
            setupFileDrop();
            
            // Initialize datalists
            updateDatalists();
        });
        
        // Initialize the application
        function initApp() {
            // Fetch initial data
            fetchBudgets();
            fetchDashboardStats();
            fetchRecentExpenses();
            
            // Check for dark mode preference
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            if (this.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'enabled');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'disabled');
            }
        }
        
        // Setup file drop functionality
        function setupFileDrop() {
            const fileContainer = document.getElementById('fileUploadContainer');
            
            fileContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#4361ee';
                this.style.backgroundColor = '#e6eeff';
            });
            
            fileContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#dee2e6';
                this.style.backgroundColor = '#f8fafc';
            });
            
            fileContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#dee2e6';
                this.style.backgroundColor = '#f8fafc';
                
                const files = e.dataTransfer.files;
                if (files.length) {
                    document.getElementById('evidence').files = files;
                    handleFileSelect({ target: document.getElementById('evidence') });
                }
            });
        }
        
        // Fetch budgets from the server
        function fetchBudgets() {
            fetch(API_ENDPOINTS.GET_BUDGETS, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    populateBudgetDropdown(data.data);
                    extractCategoriesAndItems(data.data);
                } else {
                    showNotification('Failed to fetch budgets', 'error');
                }
            })
            .catch(error => {
                console.error('Error fetching budgets:', error);
                showNotification('Error connecting to server', 'error');
                
                // Fallback to sample data if API fails
                const sampleData = {
                    data: [
                        {
                            budgetId: 'bIDFxW5cuMV',
                            dateOfApproval: '2023-01-10',
                            department: 'Health',
                            description: '2023 National Health Budget',
                            vote: 'VOTE-2023-HEALTH'
                        },
                        {
                            budgetId: 'bIDOlwTKCCa',
                            dateOfApproval: '2023-01-10',
                            department: 'Education',
                            description: '2023 Secondary Education Budget',
                            vote: 'VOTE-2023-EDU'
                        },
                        {
                            budgetId: 'bIDziMnNLhw',
                            dateOfApproval: '2023-01-10',
                            department: 'Health',
                            description: '2023 Q1-Q4 Health Budget - Revised per Parliament Approval',
                            vote: 'VOTE-2023-HEALTH'
                        }
                    ],
                    status: true
                };
                
                populateBudgetDropdown(sampleData.data);
                extractCategoriesAndItems(sampleData.data);
            });
        }
        
        // Extract categories and items from budgets
        function extractCategoriesAndItems(budgets) {
            budgets.forEach(budget => {
                if (budget.detailsOfBudget && budget.detailsOfBudget.categories) {
                    budget.detailsOfBudget.categories.forEach(category => {
                        // Handle both string and object formats for categories
                        if (typeof category === 'string') {
                            allCategories.add(category);
                        } else if (category && category.name) {
                            allCategories.add(category.name);
                        }
                    });
                }
                
                if (budget.detailsOfBudget && budget.detailsOfBudget.items) {
                    budget.detailsOfBudget.items.forEach(item => {
                        allItems.add(item);
                    });
                }
            });
            
            updateDatalists();
        }
        
        // Update datalists with available categories and items
        function updateDatalists() {
            const categoryDatalist = document.getElementById('categoryOptions');
            const itemDatalist = document.getElementById('itemOptions');
            
            // Clear existing options
            categoryDatalist.innerHTML = '';
            itemDatalist.innerHTML = '';
            
            // Add categories from budget
            currentBudgetCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                categoryDatalist.appendChild(option);
            });
            
            // Add items from budget
            currentBudgetItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                itemDatalist.appendChild(option);
            });
            
            // Add all known categories and items
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                categoryDatalist.appendChild(option);
            });
            
            allItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                itemDatalist.appendChild(option);
            });
        }
        
        // Search for chart accounts
        function searchChartAccounts(searchTerm, callback) {
            if (!searchTerm || searchTerm.length < 2) {
                if (callback) callback([]);
                return;
            }
            
            fetch(API_ENDPOINTS.SEARCH_CHART_ACCOUNTS, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ accountName: searchTerm })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status && data.data) {
                    const results = data.data.map(item => ({
                        value: `${item.name} -> ${item.table}`,
                        name: item.name,
                        table: item.table
                    }));
                    
                    if (callback) callback(results);
                } else {
                    if (callback) callback([]);
                }
            })
            .catch(error => {
                console.error('Error searching chart accounts:', error);
                if (callback) callback([]);
            });
        }
        
        // Fetch dashboard statistics
        function fetchDashboardStats() {
            fetch(API_ENDPOINTS.GET_DASHBOARD_STATS, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    updateDashboardStats(data.data);
                } else {
                    console.error('Failed to fetch dashboard stats');
                }
            })
            .catch(error => {
                console.error('Error fetching dashboard stats:', error);
                
                // Fallback sample data
                const sampleData = {
                    totalBudget: 1250000,
                    totalExpenses: 475000,
                    remainingBudget: 775000,
                    expenseCount: 42
                };
                
                updateDashboardStats(sampleData);
            });
        }
        
        // Update dashboard statistics
        function updateDashboardStats(data) {
            document.getElementById('totalBudget').textContent = '$' + data.totalBudget.toLocaleString();
            document.getElementById('totalExpenses').textContent = '$' + data.totalExpenses.toLocaleString();
            document.getElementById('remainingBudget').textContent = '$' + data.remainingBudget.toLocaleString();
            document.getElementById('expenseCount').textContent = data.expenseCount;
        }
        
        // Fetch recent expenses
        function fetchRecentExpenses() {
            fetch(API_ENDPOINTS.GET_RECENT_EXPENSES, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    displayRecentExpenses(data.data);
                } else {
                    console.error('Failed to fetch recent expenses');
                }
            })
            .catch(error => {
                console.error('Error fetching recent expenses:', error);
                
                // Fallback sample data
                const sampleData = [
                    {
                        id: 'exp1',
                        budget: 'VOTE-2023-HEALTH',
                        amount: 1250.50,
                        date: '2023-06-15',
                        beneficiary: 'Medical Supplies Inc.'
                    },
                    {
                        id: 'exp2',
                        budget: 'VOTE-2023-EDU',
                        amount: 3250.75,
                        date: '2023-06-14',
                        beneficiary: 'Textbook Publishers Ltd.'
                    },
                    {
                        id: 'exp3',
                        budget: 'VOTE-2023-HEALTH',
                        amount: 850.00,
                        date: '2023-06-12',
                        beneficiary: 'Regional Clinic'
                    }
                ];
                
                displayRecentExpenses(sampleData);
            });
        }
        
        // Display recent expenses in the UI
        function displayRecentExpenses(expenses) {
            const container = document.getElementById('recentExpenses');
            
            if (!expenses || expenses.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-receipt fa-2x mb-3"></i>
                        <p>No recent expenses</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            expenses.forEach(expense => {
                html += `
                    <div class="recent-expense-item">
                        <div>
                            <h6 class="mb-1">${expense.budget}</h6>
                            <small class="text-muted">${expense.date} â€¢ ${expense.beneficiary}</small>
                        </div>
                        <div class="fw-bold text-danger">$${expense.amount.toFixed(2)}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Populate budget dropdown with fetched data
        function populateBudgetDropdown(budgets) {
            const dropdown = document.getElementById('budgetId');
            dropdown.innerHTML = '<option value="">Select a budget</option>';
            
            budgets.forEach(budget => {
                const option = document.createElement('option');
                option.value = budget.budgetId;
                option.textContent = `${budget.vote} - ${budget.department}`;
                option.setAttribute('data-budget', JSON.stringify(budget));
                dropdown.appendChild(option);
            });
        }
        
        // Update budget details when a budget is selected
        function updateBudgetDetails() {
            const budgetId = this.value;
            const budgetDetails = document.getElementById('budgetDetails');
            
            if (!budgetId) {
                budgetDetails.innerHTML = `
                    <i class="fas fa-coins fa-3x text-secondary mb-3"></i>
                    <p>Select a budget to view details</p>
                `;
                
                // Clear current budget categories and items
                currentBudgetCategories = [];
                currentBudgetItems = [];
                updateDatalists();
                return;
            }
            
            const selectedOption = this.options[this.selectedIndex];
            const budgetData = JSON.parse(selectedOption.getAttribute('data-budget'));
            
            // Extract categories and items from the selected budget
            currentBudgetCategories = [];
            currentBudgetItems = [];
            
            if (budgetData.detailsOfBudget && budgetData.detailsOfBudget.categories) {
                budgetData.detailsOfBudget.categories.forEach(category => {
                    if (typeof category === 'string') {
                        currentBudgetCategories.push(category);
                        allCategories.add(category);
                    } else if (category && category.name) {
                        currentBudgetCategories.push(category.name);
                        allCategories.add(category.name);
                    }
                });
            }
            
            if (budgetData.detailsOfBudget && budgetData.detailsOfBudget.items) {
                budgetData.detailsOfBudget.items.forEach(item => {
                    currentBudgetItems.push(item);
                    allItems.add(item);
                });
            }
            
            updateDatalists();
            
            // Fetch detailed budget information
            fetch(API_ENDPOINTS.GET_BUDGET_DETAILS, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ budgetId: budgetId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    displayBudgetDetails(data.data);
                } else {
                    showNotification('Failed to fetch budget details', 'error');
                    // Display basic info from the dropdown data
                    displayBasicBudgetDetails(budgetData);
                }
            })
            .catch(error => {
                console.error('Error fetching budget details:', error);
                showNotification('Error fetching budget details', 'error');
                // Display basic info from the dropdown data
                displayBasicBudgetDetails(budgetData);
            });
        }
        
        // Display basic budget details (fallback)
        function displayBasicBudgetDetails(budget) {
            const budgetDetails = document.getElementById('budgetDetails');
            
            budgetDetails.innerHTML = `
                <h5>${budget.vote}</h5>
                <p class="text-muted">${budget.department} Department</p>
                <p>${budget.description}</p>
                <div class="mt-3 text-start">
                    <p><strong>Approval Date:</strong> ${budget.dateOfApproval}</p>
                    <p class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i> Detailed budget information not available</p>
                </div>
            `;
        }
        
        // Display detailed budget information
        function displayBudgetDetails(details) {
            const budgetDetails = document.getElementById('budgetDetails');
            const utilizationPercentage = (details.amountSpent / details.totalBudget) * 100;
            
            budgetDetails.innerHTML = `
                <h5>${details.vote}</h5>
                <p class="text-muted">${details.department} Department</p>
                <div class="expense-summary mt-4">
                    <h6>Budget Summary</h6>
                    <div class="d-flex justify-content-between mt-3">
                        <span>Total Budget:</span>
                        <span>$${details.totalBudget.toLocaleString()}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Amount Spent:</span>
                        <span>$${details.amountSpent.toLocaleString()}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Remaining:</span>
                        <span>$${details.remainingBudget.toLocaleString()}</span>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 12px;">
                        <div class="progress-bar" role="progressbar" style="width: ${utilizationPercentage}%;" 
                            aria-valuenow="${utilizationPercentage}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted">${utilizationPercentage.toFixed(1)}% utilized</small>
                </div>
            `;
        }
        
        // Add a new detail item row
        function addDetailItem() {
            const container = document.getElementById('detailsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'detail-item';
            newItem.innerHTML = `
                <div class="combobox-container" style="flex: 1;">
                    <input type="text" class="form-control item-input" list="itemOptions" placeholder="Item" required>
                </div>
                <div class="combobox-container" style="flex: 1;">
                    <input type="text" class="form-control category-input" list="categoryOptions" placeholder="Category" required>
                </div>
                <input type="number" class="form-control" placeholder="Quantity" min="1" required>
                <input type="number" class="form-control" placeholder="Amount" min="0" step="0.01" required>
                <button type="button" class="btn btn-danger remove-detail"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(newItem);
            
            // Add event listener to the remove button
            newItem.querySelector('.remove-detail').addEventListener('click', function() {
                container.removeChild(newItem);
                calculateTotalAmount();
            });
            
            // Add input event listeners to calculate total
            const inputs = newItem.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', calculateTotalAmount);
            });
            
            // Add event listeners for searching chart accounts
            const categoryInput = newItem.querySelector('.category-input');
            const itemInput = newItem.querySelector('.item-input');
            
            // Setup debounced search for category input
            setupSearchInput(categoryInput, searchChartAccounts, function(results) {
                updateDatalistOptions('categoryOptions', results.map(r => r.value));
            });
            
            // Setup debounced search for item input
            setupSearchInput(itemInput, searchChartAccounts, function(results) {
                updateDatalistOptions('itemOptions', results.map(r => r.value));
            });
        }
        
        // Setup search input with debouncing
        function setupSearchInput(inputElement, searchFunction, callback) {
            let timeoutId;
            
            inputElement.addEventListener('input', function() {
                clearTimeout(timeoutId);
                const searchTerm = this.value;
                
                if (searchTerm.length > 1) {
                    timeoutId = setTimeout(() => {
                        searchFunction(searchTerm, callback);
                    }, 300);
                }
            });
            
            inputElement.addEventListener('focus', function() {
                const searchTerm = this.value;
                if (searchTerm.length > 1) {
                    searchFunction(searchTerm, callback);
                }
            });
        }
        
        // Update datalist options
        function updateDatalistOptions(datalistId, options) {
            const datalist = document.getElementById(datalistId);
            if (!datalist) return;
            
            // Clear existing options
            datalist.innerHTML = '';
            
            // Add new options
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                datalist.appendChild(optionElement);
            });
        }
        
        // Calculate total amount from all detail items
        function calculateTotalAmount() {
            const detailItems = document.querySelectorAll('.detail-item');
            let total = 0;
            
            detailItems.forEach(item => {
                const quantity = parseFloat(item.querySelector('input[placeholder="Quantity"]').value) || 0;
                const amount = parseFloat(item.querySelector('input[placeholder="Amount"]').value) || 0;
                total += quantity * amount;
            });
            
            document.getElementById('amountSpent').value = total.toFixed(2);
        }
        
        // Handle file selection for evidence
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('File size exceeds 5MB limit', 'error');
                event.target.value = '';
                return;
            }
            
            const fileName = document.getElementById('fileName');
            const filePreview = document.getElementById('filePreview');
            fileName.textContent = file.name;
            
            // Check if file is an image
            if (file.type.match('image.*')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    filePreview.src = e.target.result;
                    filePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                filePreview.style.display = 'none';
            }
        }
        
        // Handle form submission
        function handleSubmit(event) {
            event.preventDefault();
            
            // Basic validation
            const form = event.target;
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Get form data
            const formData = {
                budgetId: document.getElementById('budgetId').value,
                dateOfExpense: document.getElementById('dateOfExpense').value,
                detailsOfExpense: getDetailsOfExpense(),
                amountSpent: parseFloat(document.getElementById('amountSpent').value),
                beneficiary: document.getElementById('beneficially').value,
                evidence: document.getElementById('evidence').files[0],
                notes: document.getElementById('others').value
            };
            
            // Create FormData object for file upload
            const apiFormData = new FormData();
            apiFormData.append('budgetId', formData.budgetId);
            apiFormData.append('dateOfExpense', formData.dateOfExpense);
            apiFormData.append('detailsOfExpense', JSON.stringify(formData.detailsOfExpense));
            apiFormData.append('amountSpent', formData.amountSpent);
            apiFormData.append('beneficiary', formData.beneficiary);
            apiFormData.append('evidence', formData.evidence);
            apiFormData.append('notes', formData.notes);
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
            submitBtn.disabled = true;
            
            // Submit to server
            fetch(API_ENDPOINTS.ADD_EXPENSE, {
                method: 'POST',
                body: apiFormData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    // Show success notification
                    showNotification('Expense added successfully!', 'success');
                    
                    // Reset form
                    form.reset();
                    document.getElementById('detailsContainer').innerHTML = `
                        <div class="detail-item">
                            <div class="combobox-container" style="flex: 1;">
                                <input type="text" class="form-control item-input" list="itemOptions" placeholder="Item" required>
                            </div>
                            <div class="combobox-container" style="flex: 1;">
                                <input type="text" class="form-control category-input" list="categoryOptions" placeholder="Category" required>
                            </div>
                            <input type="number" class="form-control" placeholder="Quantity" min="1" required>
                            <input type="number" class="form-control" placeholder="Amount" min="0" step="0.01" required>
                            <button type="button" class="btn btn-danger remove-detail"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    document.getElementById('filePreview').style.display = 'none';
                    document.getElementById('fileName').textContent = '';
                    
                    // Refresh data
                    fetchDashboardStats();
                    fetchRecentExpenses();
                } else {
                    showNotification('Failed to add expense: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error submitting expense:', error);
                showNotification('Error connecting to server', 'error');
            })
            .finally(() => {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }
        
        // Get details of expense from the form
        function getDetailsOfExpense() {
            const details = [];
            const detailItems = document.querySelectorAll('.detail-item');
            
            detailItems.forEach(item => {
                const inputs = item.querySelectorAll('input');
                details.push({
                    item: inputs[0].value,
                    category: inputs[1].value,
                    quantity: parseInt(inputs[2].value),
                    amount: parseFloat(inputs[3].value)
                });
            });
            
            return details;
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            if (type === 'success') {
                notification.style.backgroundColor = '#198754';
                notification.querySelector('i').className = 'fas fa-check-circle me-2';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
                notification.querySelector('i').className = 'fas fa-exclamation-circle me-2';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>